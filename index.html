<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TaGra</title>
  <link rel="stylesheet" href="base.css">
</head>
<body>
  <p id="title">TaGra</p>
  <!--ã‚­ãƒ£ãƒ³ãƒã‚¹-->
<div id="workspace">
  <div id="container">
    <div id="canvas-wrapper">
      <!-- drawCanvas ã¯layer[aI].canvasã«ã€‚å‹•çš„ã«è¿½åŠ ã™ã‚‹-->
    </div>
    <!-- cursorCanvasã‚’æœ€å‰é¢ã§ç‹¬ç«‹ã•ã›ã‚‹-->
    <canvas id="cursorCanvas">ã‚«ãƒ¼ã‚½ãƒ«ã‚­ãƒ£ãƒ³ãƒã‚¹</canvas>
  </div>
  <div id="layer-container">
    <div id ="layer-container-buttons">
      <button id="add-layer">æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
      <button id="add-layer-name">åå‰ã‚’ä»˜ã‘ã¦æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
      <button id="add-layer-same-tags">åŒã˜ã‚¿ã‚°ã§æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼</button>
    </div>

  <div id="layer-panel"></div>
  <div id="layer-search-wrapper">
    <input type="text" id="layer-search" placeholder="ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢(and,orå¯¾å¿œ)" />
    <button id="layer-search-clear">Ã—</button>
  </div>

  <div id="search-results-panel"></div>

  </div>

</div>
  <hr>
  <!-- ç·šã®å¤ªã•èª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼/inputã¨ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚‚ã® -->
  <div id="brush-size">
    <label for="brush-width">ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º:</label>
    <button id="brush-decrease">-</button>
    <input type="range" id="brush-width" min="1" max="20" value="2">
    <button id="brush-increase"> + </button>
    <span id="brush-size-display">2</span>px
  </div>
  <!--æ¶ˆã—ã‚´ãƒ ã‚µã‚¤ã‚º/åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³-->
  <div id="eraser-block">
    <div id="eraser">
      <label for="eraser-width">æ¶ˆã—ã‚´ãƒ ã‚µã‚¤ã‚º:</label>
      <button id="eraser-decrease">-</button>
      <input type="range" id="eraser-width" min="1" max="40" value="8">
      <button id="eraser-increase">+</button>
      <span id="eraser-size-display">8</span>px
    </div>
    <button id="mode-toggle">æ¶ˆã—ã‚´ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ</button>
    <button id="nagenawafill-toggle">æŠ•ã’ãªã‚å¡—ã‚Šï¼š<b>OFF</b></button>
  </div>

  <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼&ä¸é€æ˜åº¦ã®html -->
<div id="color-block">
  <input type="color" id="color-picker" value="#000000" />
  <label for="alpha">ä¸é€æ˜åº¦:</label>
    <input type="range" id="alpha" min="0" max="100" value="100">
    <span id="alpha-display">100</span>%<br>
</div>
<div id="undo-redo">
  <button id="undo-button">â†å–ã‚Šæ¶ˆã—</button>
  <button id="redo-button">ã‚„ã‚Šç›´ã—â†’</button>
</div>
<script>
//Javascriptã¯bodyã®æœ€ä¸‹éƒ¨ã«æ›¸ãã€‚ã“ã‚Œã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
const wrapper = document.getElementById("canvas-wrapper");
const cursorCanvas = document.getElementById("cursorCanvas");
const cursorCtx = cursorCanvas.getContext("2d", { willReadFrequently: true });  //èª­ã¿è¾¼ã¿å„ªå…ˆ
  //ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚ºã‚’å–å¾—
  const brushWidthSlider = document.getElementById('brush-width');
  const eraserWidthSlider = document.getElementById('eraser-width');
  const brushSizeDisplay = document.getElementById('brush-size-display');
  const eraserSizeDisplay = document.getElementById('eraser-size-display');
  //ãƒœã‚¿ãƒ³ã‚’å–å¾—
  const brushDecreaseBtn  = document.getElementById('brush-decrease');
  const brushIncreaseBtn  = document.getElementById('brush-increase');
  const eraserDecreaseBtn = document.getElementById('eraser-decrease');
  const eraserIncreaseBtn = document.getElementById('eraser-increase');
  const addLayerBtn = document.getElementById("add-layer");
  const addLayerNameBtn = document.getElementById('add-layer-name');
  const addLayerSTBtn = document.getElementById("add-layer-same-tags");
  const undoButton = document.getElementById("undo-button");
  const redoButton = document.getElementById("redo-button");
  //ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é–¢é€£ã™ã‚‹å¤‰æ•°(æ—§)
  //ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é–¢é€£ã™ã‚‹å¤‰æ•°(æ—§)
  //let layers = [];  //ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã™ã‚‹é…åˆ—
  //let activeIndex = 0;  //ä½•ç•ªç›®ã‚’æç”»ä¸­ï¼Ÿ

  //æç”»ãƒ•ãƒ©ã‚°ã¨åº§æ¨™ã®åˆæœŸåŒ–
    let isDrawing = false;
    let isErasing = false;

    let lastX = 0;
    let lastY = 0;

class Layer {
  constructor(name) {
    this.name = name;
    //å‘½åã‚’ã‚¿ã‚°ä»£ã‚ã‚Šã«ã—ã¦ã€è¦å‰‡ã«å¾“ã£ã¦æ•´ç†ã™ã‚‹
    this.nameParts = name.split(/[/_,ã€]/).map(s => s.trim()).filter(s => s);
    this.canvas = document.createElement("canvas");
    this.ctx = this.canvas.getContext("2d", { willReadFrequently: true });
    this._visible = true; //å†…éƒ¨å¤‰æ•°ã¨ã—ã¦æ‰±ã†ã¨ãã¯"_"
    this.canvas.style.display = "block"; // åˆæœŸè¡¨ç¤º
  }
//ã‚²ãƒƒã‚¿ãƒ¼
  get visible() {
    return this._visible;
  }
//setã¯å¤‰æ•°ãŒå¤‰ã‚ã£ãŸæ™‚ã«è‡ªå‹•çš„ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°â†’è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚’åŒæ™‚ã«è¡Œãˆã‚‹ã®ã¯ã‚»ãƒƒã‚¿ãƒ¼ã‚’ä»‹ã™ã‚‹ã‹ã‚‰
  set visible(v) {
    this._visible = v;
    this.canvas.style.display = v ? "block" : "none"; // â† è¡¨ç¤º/éè¡¨ç¤ºã‚’è‡ªå‹•åˆ‡æ›¿
  }
}
/* ===================== LayerManager ===================== */
class LayerManager {
  constructor(wrapper) {
    this.wrapper   = wrapper;
    this.layers    = [];
    this.AI        = 0;   // Active Index
    this.nextId    = 1;   // åå‰ã®é€£ç•ªç”¨
    this._dropIndicator = null;  // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
  }

  /* --- è¿½åŠ  ------------------------------------------------------- */
  addLayer(name = `Layer ${this.nextId++}`, skipHistory = false) {
    const layer = new Layer(name);
    const { clientWidth: w, clientHeight: h } = this.wrapper;

    layer.canvas.width  = w;
    layer.canvas.height = h;
    layer.canvas.style.zIndex   = this.layers.length + 1;
    layer.canvas.style.position = "absolute";
    layer.canvas.style.top      = "0";
    layer.canvas.style.left     = "0";

    this.wrapper.appendChild(layer.canvas);
    applyBrushStyle(layer.ctx);

    this.layers.push(layer);
    this.AI = this.layers.length - 1;
    this.renderLayerPanel();

    if (!skipHistory) {
      const idx = this.layers.length - 1;
      appHistory.push({
        undo: () => this.removeLayer(idx, true),
        redo: () => this.addLayer(name, true),
      });
    }
    return layer;
  }

  /* --- å‰Šé™¤ ------------------------------------------------------- */
  removeLayer(index, skipHistory = false) {
    if (this.layers.length <= 1) {
      alert("ã‚¨ãƒ©ãƒ¼ï¼šãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’0æšã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚");
      return false;
    }
    const layer = this.layers[index];
    if (!layer) return false;

    const snapshot = {
      name      : layer.name,
      visible   : layer.visible,
      imageData : layer.ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height),
      index,
    };

    if (!skipHistory) {
      appHistory.push({
        undo: () => {
          const l = new Layer(snapshot.name);
          l.visible = snapshot.visible;
          l.canvas.width  = snapshot.imageData.width;
          l.canvas.height = snapshot.imageData.height;
          l.canvas.style.position = "absolute";
          l.canvas.style.top = l.canvas.style.left = "0";
          l.ctx.putImageData(snapshot.imageData, 0, 0);
          this.layers.splice(snapshot.index, 0, l);
          this.wrapper.appendChild(l.canvas);
          this.renderZIndex();
          this.AI = snapshot.index;
          this.renderLayerPanel();
        },
        redo: () => this.removeLayer(snapshot.index, true),
      });
    }

    this.wrapper.removeChild(layer.canvas);
    this.layers.splice(index, 1);
    if (index <= this.AI) this.AI = Math.max(0, this.AI - 1);
    this.renderLayerPanel();
    return true;
  }

  /* --- åå‰å¤‰æ›´ --------------------------------------------------- */
  renameLayer(index, newName, skipHistory = false) {
    const layer = this.layers[index];
    if (!layer || layer.name === newName) return;
    const oldName = layer.name;
    layer.name = newName;
    layer.nameParts = newName.split(/[/_,ã€]/).map(s => s.trim()).filter(s => s); // å†…éƒ¨æ›´æ–°ã ã‘è¿½åŠ ï¼

    this.renderLayerPanel();

    if (!skipHistory) {
      appHistory.push({
        undo: () => this.renameLayer(index, oldName, true),
        redo: () => this.renameLayer(index, newName, true),
      });
    }
  }

  /* --- ä¸¦ã¹æ›¿ãˆï¼ˆå±¥æ­´å¯¾å¿œï¼‰ ------------------------------------- */
  reorderLayer(oldIdx, newIdx, skipHistory = false) {
    if (oldIdx === newIdx) return;
    const layer = this.layers[oldIdx];
    if (!layer) return;

    if (!skipHistory) {
      appHistory.push({
        undo: () => this.reorderLayer(newIdx, oldIdx, true),
        redo: () => this.reorderLayer(oldIdx, newIdx, true),
      });
    }

    this.layers.splice(oldIdx, 1);
    this.layers.splice(newIdx, 0, layer);

    this.AI = this.layers.indexOf(layer);
    this.renderZIndex();
    this.renderLayerPanel();
  }

  /* --- ä¸Šä¸‹ç§»å‹•ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰ ------------------------------------- */
  moveLayer(index, direction, skipHistory = false) {
    const target = direction === "up" ? index + 1 : index - 1;
    if (target < 0 || target >= this.layers.length) return;
    this.reorderLayer(index, target, skipHistory);
  }

  /* --- å¯è¦–/ä¸å¯è¦– ------------------------------------------------ */
  toggleVisibility(index) {
  const layer = this.layers[index];
  layer.visible = !layer.visible;  // â† setter ãŒ display åˆ‡ã‚Šæ›¿ãˆã¦ãã‚Œã‚‹â™¡
}


  /* --- è¤‡è£½ ------------------------------------------------------- */
  duplicateLayer(index) {
    const original = this.layers[index];
    if (!original) return null;

    const newLayer = new Layer(`${original.name} copy`);
    newLayer.canvas.width  = original.canvas.width;
    newLayer.canvas.height = original.canvas.height;
    newLayer.ctx.drawImage(original.canvas, 0, 0);
    newLayer.canvas.style.position = "absolute";
    newLayer.canvas.style.top = newLayer.canvas.style.left = "0";
    newLayer.canvas.style.zIndex = this.layers.length + 1;
    this.wrapper.appendChild(newLayer.canvas);
    applyBrushStyle(newLayer.ctx);

    this.layers.push(newLayer);
    this.AI = this.layers.length - 1;
    this.renderLayerPanel();
    return newLayer;
  }

  /* --- ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ------------------------------------------------- */
  getActiveLayer() { return this.layers[this.AI] ?? null; }
  setActive(idx) {
    if (idx < 0 || idx >= this.layers.length) return;

    this.AI = idx;

    updateBrushColor();             // â† ã‚«ãƒ©ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã®å†é©ç”¨
    this.updateActiveHighlight();  // â† UIå´ã®å¼·èª¿è¡¨ç¤ºæ›´æ–°
    toolMgr.applyStyleTo(this.getActiveLayer()?.ctx);  // â˜… ã‚¹ã‚¿ã‚¤ãƒ«å†é©ç”¨
  }

  /* --- Z-index å†è¨ˆç®— ------------------------------------------- */
  renderZIndex() {
    this.layers.forEach((l, i) => { l.canvas.style.zIndex = i + 1; });
  }

  /* --- ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—ï¼ˆä»»æ„åˆ©ç”¨ï¼‰ ------------------------------ */
  getLayerList() {
    return this.layers.map((l, i) => ({
      index  : i,
      name   : l.name,
      visible: l.visible ?? true,
      active : i === this.AI,
    }));
  }

  /* --- ãƒ‘ãƒãƒ«å†æç”»ï¼‹DnD ---------------------------------------- */
  renderLayerPanel() {
    const panel = document.getElementById("layer-panel");
    panel.innerHTML = "";

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿ç”Ÿæˆï¼‰
    if (!this._dropIndicator) {
      const di = document.createElement("div");
      di.className = "drop-indicator";
      di.style.display = "none";
      panel.appendChild(di);
      this._dropIndicator = di;
    }
    const dropIndicator = this._dropIndicator;
    let draggedIdx = null;

    /* ---------- 1. è¡Œç”Ÿæˆ ---------- */
    this.layers.forEach((layer, idx) => {
      const item = document.createElement("div");
      item.className   = "layer-item";
      item.dataset.index = idx;
      if (idx === this.AI) item.classList.add("active-layer");
      item.setAttribute("draggable", true);

      // åå‰æ¬„
      const nameSpan = document.createElement("span");
      nameSpan.className = "layer-name";
      nameSpan.textContent = layer.name;
      nameSpan.setAttribute("draggable", false);
      nameSpan.addEventListener("dblclick", e => {
  e.stopPropagation();
  const input = document.createElement("input");
  input.type = "text";
  input.value = layer.name;
  input.className = "rename-input";

  let confirmed = false;

  const finish = ok => {
    if (ok) this.renameLayer(idx, input.value.trim() || layer.name);
    else    this.renderLayerPanel();
    document.removeEventListener("mousedown", cancelIfOutside);
  };

  const cancelIfOutside = ev => {
    if (!input.contains(ev.target)) {
      finish(false);
    }
  };

input.addEventListener("keydown", ev => {
  if (ev.key === "Enter" && !ev.isComposing) {
    confirmed = true;
    finish(true);
  }
  if (ev.key === "Escape") {
    confirmed = false;
    finish(false);
  }
});


  input.addEventListener("blur", () => {
    if (confirmed) return; // Enterã§ç¢ºå®šæ¸ˆãªã‚‰ä½•ã‚‚ã—ãªã„
    // ç¢ºå®šå‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå¤–ã‚¯ãƒªãƒƒã‚¯å«ã‚€ï¼‰
    finish(false);
  });

  document.addEventListener("mousedown", cancelIfOutside);
  nameSpan.replaceWith(input);
  input.focus(); input.select();
});


      // é¸æŠ
      item.addEventListener("click", () => { this.setActive(idx); });

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const del = document.createElement("button");
      del.className = "delete-button";
      del.textContent = "âœ•";
      del.setAttribute("draggable", false);
      del.addEventListener("click", e => {
        e.stopPropagation();
        this.removeLayer(idx);
      });

      // âœ… å¯è¦–çŠ¶æ…‹ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
      const visBtn = document.createElement("button");
      visBtn.className = "visibility-button";
      visBtn.textContent = layer.visible ? "âœ…" : "ğŸš«";
      visBtn.title = layer.visible ? "éè¡¨ç¤ºã«ã™ã‚‹" : "è¡¨ç¤ºã™ã‚‹";

      visBtn.addEventListener("click", e => {
        e.stopPropagation();
        this.toggleVisibility(idx);
        this.renderLayerPanel(); // å†æç”»ã§ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°â™¡
      });

      // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼çµ‚äº†
      item.addEventListener("dragstart", e => {
        draggedIdx = idx;
        item.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", ""); // for Firefox
      });
      item.addEventListener("dragend", () => {
        item.classList.remove("dragging");
        dropIndicator.style.display = "none";
      });

      // é€†é †è¡¨ç¤º
      item.appendChild(nameSpan);
      item.appendChild(visBtn);
      item.appendChild(del);
      panel.prepend(item);
    });

    /* ---------- 2. ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ ---------- */
    panel.addEventListener("dragover", e => {
      e.preventDefault();
      if (draggedIdx == null) return;

      const tgt = e.target.closest(".layer-item");
      if (!tgt) return;

      const rect = tgt.getBoundingClientRect();
      const before = e.clientY < rect.top + rect.height / 2;

      dropIndicator.style.display = "block";
      panel.insertBefore(dropIndicator, before ? tgt : tgt.nextSibling);

      const rows = Array.from(panel.querySelectorAll(".layer-item, .drop-indicator"));
      const vis  = rows.indexOf(dropIndicator);
      let logical = this.layers.length - 1 - vis;
      if (logical > draggedIdx) logical -= 1;
      dropIndicator.classList.toggle("below", logical > draggedIdx);
    });

    /* ---------- 3. ãƒ‰ãƒ­ãƒƒãƒ— ---------- */
    panel.addEventListener("drop", e => {
      e.preventDefault();
      if (draggedIdx == null) return;

      const rows = Array.from(panel.querySelectorAll(".layer-item, .drop-indicator"));
      const vis  = rows.indexOf(dropIndicator);
      let target = this.layers.length - 1 - vis;
      target = Math.min(Math.max(target, 0), this.layers.length - 1);

      this.reorderLayer(draggedIdx, target);
      draggedIdx = null;
      dropIndicator.style.display = "none";
    });

    this.updateActiveHighlight();
    //æ¤œç´¢çµæœã®æ›´æ–°
    const searchInput = document.getElementById("layer-search");
    const currentKeyword = searchInput?.value ?? "";
    this.renderSearchResults(currentKeyword);
  }

  /* --- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–° ----------------------------- */
  updateActiveHighlight() {
    const items = document.querySelectorAll("#layer-panel .layer-item");
    const n = this.layers.length;
    items.forEach((row, i) => {
      const logicalIdx = n - 1 - i; // prepend è¡¨ç¤ºãªã®ã§åè»¢
      row.classList.toggle("active-layer", logicalIdx === this.AI);
    });
  }
    /* --- æ¤œç´¢ãƒ’ãƒƒãƒˆã‚’åŠé€æ˜åŒ–ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ—§ updateSearchï¼‰ --- */
  updateSearch(rawKeyword) {
    const clauses = parseSearchQuery(rawKeyword);
    const panel   = document.getElementById("layer-panel");
    const items   = panel.querySelectorAll(".layer-item");
    const n       = this.layers.length;

    items.forEach((item, visIdx) => {
      const idx   = n - 1 - visIdx;
      const layer = this.layers[idx];
      const hay   = [layer.name.toLowerCase(), ...layer.nameParts.map(p => p.toLowerCase())];
      const hit   = clauses.length === 0
                  ? true
                  : clauses.some(andList =>
                      andList.every(token =>
                        hay.some(f => f.includes(token))
                      )
                    );
      item.classList.toggle("dimmed", !hit);
    });
  }

  /* --- æ¤œç´¢ãƒ’ãƒƒãƒˆã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘åˆ¥æ ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ—§ renderSearchResultsï¼‰ --- */
  renderSearchResults(rawKeyword) {
    const clauses = parseSearchQuery(rawKeyword);
    const panel   = document.getElementById("search-results-panel");
    panel.innerHTML = "";

    if (clauses.length === 0) return;

    this.layers.forEach((layer, idx) => {
      const hay = [layer.name.toLowerCase(), ...layer.nameParts.map(p => p.toLowerCase())];
      const hit = clauses.some(andList =>
        andList.every(token =>
          hay.some(f => f.includes(token))
        )
      );
      if (!hit) return;

      const div = document.createElement("div");
      div.className = "search-result-item";
      div.textContent = layer.name;
      div.addEventListener("click", () => this.setActive(idx));
      panel.appendChild(div);
    });
  }
}
/* =================== /LayerManager ====================== */
// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ToolManagerï¼ˆç­†ç®±ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ToolManager {
  constructor() {
    const toCanvas = e => {
      const rect   = wrapper.getBoundingClientRect();
      const scaleX = wrapper.clientWidth  / rect.width;
      const scaleY = wrapper.clientHeight / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top)  * scaleY
      };
    };

    this.current = null;
    this.ctx = {
  brush: {
    name: 'Brush',
    size: +brushWidthSlider.value, // â† åˆæœŸã‚µã‚¤ã‚ºã‚’ã‚»ãƒƒãƒˆ
    isDrawing: false,
    onDown(e, { drawCtx }) {
      this.isDrawing = true;
      const p = toCanvas(e);
      drawCtx.beginPath();
      drawCtx.moveTo(p.x, p.y);
      drawCtx.lineWidth = this.size; // â† é©ç”¨ï¼
    },
    onMove(e, { drawCtx }) {
      if (!this.isDrawing) return;
      const p = toCanvas(e);
      drawCtx.lineTo(p.x, p.y);
      drawCtx.stroke();
    },
    onUp(e) {
      this.isDrawing = false;
    }
  },

  eraser: {
    name: 'Eraser',
    size: +eraserWidthSlider.value,
    isDrawing: false,
    onDown(e, { drawCtx }) {
      this.isDrawing = true;
      drawCtx.save();
      drawCtx.globalCompositeOperation = 'destination-out';
      drawCtx.lineWidth = this.size;
      const p = toCanvas(e);
      drawCtx.beginPath();
      drawCtx.moveTo(p.x, p.y);
    },
    onMove(e, { drawCtx }) {
      if (!this.isDrawing) return;
      const p = toCanvas(e);
      drawCtx.lineTo(p.x, p.y);
      drawCtx.stroke();
    },
    onUp(e, { drawCtx }) {
      this.isDrawing = false;
      drawCtx.restore();
    }
  }
}

  }
  applyStyleTo(ctx) {
      if (!ctx || !this.current) return;

      const tool = this.current;
      if (tool.name === 'Brush') {
        ctx.lineWidth = tool.size;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalCompositeOperation = 'source-over';
        brushWidthSlider.value = tool.size;
      } else if (tool.name === 'Eraser') {
        ctx.lineWidth = tool.size;
        ctx.globalCompositeOperation = 'destination-out';
        eraserWidthSlider.value = tool.size;
      }
      console.log("applyStyleToãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ.");
    }
  select(name) {
    if (!this.ctx[name]) throw new Error(`ãƒ„ãƒ¼ãƒ«ã€Œ${name}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    this.current = this.ctx[name];
  }

  onDown(e, ctxs) { this.current?.onDown?.(e, ctxs); }
  onMove(e, ctxs) { this.current?.onMove?.(e, ctxs); }
  onUp(e,   ctxs) { this.current?.onUp?.(e,   ctxs); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€
const toolMgr = new ToolManager();
// æœ€åˆã¯ãƒ–ãƒ©ã‚·ã‚’é¸æŠ
toolMgr.select("brush");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ CursorManager â”€â”€â”€â”€â”€â”€â”€â”€â”€
class CursorManager {
  constructor(wrapper, cursorCanvas, toolMgr, brushSlider, eraserSlider) {
    this.wrapper       = wrapper;
    this.canvas        = cursorCanvas;
    this.ctx         = cursorCanvas.getContext('2d');
    this.toolMgr       = toolMgr;
    this.brushSlider   = brushSlider;
    this.eraserSlider  = eraserSlider;

    // ã‚µã‚¤ã‚ºåˆã‚ã›
    this.resize();
    window.addEventListener('resize', () => this.resize());

    // ãƒã‚¦ã‚¹å‹•ã‹ã™ãŸã³ã«æç”»
    wrapper.addEventListener('pointermove', e => this.draw(e));
    wrapper.addEventListener('pointerleave', () => this.clear());

  }

  resize() {
    const rect = this.wrapper.getBoundingClientRect();
    this.canvas.width  = rect.width;
    this.canvas.height = rect.height;
  }

  draw(e) {
    const rect   = this.wrapper.getBoundingClientRect();
    const scaleX = this.canvas.width  / rect.width;
    const scaleY = this.canvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top)  * scaleY;

const size = this.toolMgr.current.size;


    // ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ãƒªãƒ³ã‚°æç”»
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    this.ctx.beginPath();
    this.ctx.lineWidth   = 1;
    this.ctx.strokeStyle = 'rgba(0,0,0,0.6)';
    this.ctx.arc(x, y, size/2, 0, Math.PI*2);
    this.ctx.stroke();
  }
  clear() {
  this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
}

}

const cursorMgr    = new CursorManager(
  wrapper, cursorCanvas, toolMgr,
  brushWidthSlider, eraserWidthSlider
);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ DrawManagerï¼ˆã‚«ãƒ¼ã‚½ãƒ«æ©Ÿèƒ½ãªã—ç‰ˆï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
class DrawManager {
  constructor(wrapper, layerManager) {
    this.wrapper      = wrapper;
    this.layerManager = layerManager;
    this.isDrawing    = false;
    this.lastX        = 0;
    this.lastY        = 0;
    this.beforeImage  = null;

    wrapper.addEventListener('pointerdown',  e => this.onDown(e));
    wrapper.addEventListener('pointermove',  e => this.onMove(e));
    wrapper.addEventListener('pointerup',    e => this.onUp(e));
    wrapper.addEventListener('pointerleave', e => this.onUp(e));
  }

  toCanvas(e) {
    const rect = this.wrapper.getBoundingClientRect();
    const scaleX = this.wrapper.clientWidth  / rect.width;
    const scaleY = this.wrapper.clientHeight / rect.height;
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top)  * scaleY
    };
  }

  onDown(e) {
    this.isDrawing = true;
    const layer = this.layerManager.getActiveLayer();
    if (layer) {
      // å±¥æ­´ç”¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
      this.beforeImage = layer.ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height);
    }
    const { x, y } = this.toCanvas(e);
    this.lastX = x;
    this.lastY = y;
    // 1ãƒ‰ãƒƒãƒˆã ã‘ã§ã‚‚æã
    const ctx = this.layerManager.getActiveLayer().ctx;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x+0.01, y+0.01);
    ctx.stroke();
  }

  onMove(e) {
    if (!this.isDrawing || e.buttons !== 1) return;
    const { x, y } = this.toCanvas(e);
    const ctx = this.layerManager.getActiveLayer().ctx;
    ctx.beginPath();
    ctx.moveTo(this.lastX, this.lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    this.lastX = x;
    this.lastY = y;
  }

  onUp(e) {
    if (!this.isDrawing) return;
    this.isDrawing = false;
    const layer = this.layerManager.getActiveLayer();
    if (layer && this.beforeImage) {
      const ctx = layer.ctx;
      const after = ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height);
      // å±¥æ­´ç™»éŒ²
      const snapBefore = this.beforeImage;
      appHistory.push({
        undo: () => ctx.putImageData(snapBefore, 0, 0),
        redo: () => ctx.putImageData(after,    0, 0)
      });
      this.beforeImage = null;
    }
  }
}

class History {
  constructor(limit = 100) {
    this.historyStack   = [];    // { undo: Function, redo: Function } ã®é…åˆ—
    this.pointer = -1;    // ç¾åœ¨é©ç”¨ä¸­ã®æ“ä½œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    this.limit   = limit; // æœ€å¤§ä¿æŒæ•°
  }

  push(action) {
    if (this.pointer < this.historyStack.length - 1) {
      this.historyStack.splice(this.pointer + 1); // çµæœãŒåˆ†å²ã™ã‚‹
    }
    this.historyStack.push(action);
    if (this.historyStack.length > this.limit) {
      this.historyStack.shift();  // æœ€åˆã®1ã¤ã‚’å‰Šé™¤
    } else {
      this.pointer++;
    }
  }

undo() {
  if (this.pointer < 0) {
    console.warn("[Undo] æ“ä½œã§ãã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚pointer =", this.pointer);
    return;
  }else{
    console.log("undoãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ.",appHistory.historyStack);
  }
  this.historyStack[this.pointer].undo();
  this.pointer--;
}

redo() {
  if (this.pointer >= this.historyStack.length - 1) {
    console.warn("[Redo] æˆ»ã›ã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“ã€‚pointer =", this.pointer);
    return;
  }else{
    console.log("redoãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ.",appHistory.historyStack);
  }
  this.pointer++;
  this.historyStack[this.pointer].redo();
}
  reset() {
  this.historyStack = [];
  this.pointer = -1;
}

}


function applyBrushStyle(ctx){
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
}
//ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
addLayerBtn.addEventListener("click", () => {
  console.log("add-layer pushed!");
  manager.addLayer()
});

//ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ã¨åŒæ™‚ã«å‘½å
addLayerNameBtn.addEventListener('click', () => {
  // 1) æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å–å¾—
  const newLayer   = manager.addLayer();      // addLayer ã¯æœ«å°¾ã«è¿½åŠ æ¸ˆã¿
  const newIdx     = manager.layers.length - 1;

  // 2) ç›´å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
  manager.setActive(newIdx);

  // 3) ãƒ¬ã‚¤ãƒ¤ãƒ¼é …ç›®ã® <span.layer-name> ã‚’æ¢ã™
  const row = document.querySelector(`#layer-panel .layer-item[data-index="${newIdx}"]`);
  if (!row) return;
  const nameSpan = row.querySelector('.layer-name');
  if (!nameSpan) return;

  // 4) rename ã® <input> ã‚’ç”Ÿæˆã—ã¦å³ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  const input = document.createElement('input');
  input.type  = 'text';
  input.value = newLayer.name;
  input.className = 'rename-input';

  // Enter / Esc / blur ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  const finish = ok => {
    if (ok) manager.renameLayer(newIdx, input.value.trim() || newLayer.name);
    manager.renderLayerPanel();
  };

input.addEventListener('keydown', e => {
  /* IME å¤‰æ›ä¸­ï¼ˆisComposing=trueï¼‰ã® Enter ã¯ç„¡è¦– */
  if (e.key === 'Enter' && !e.isComposing) {
    finish(true);            // â† 1å›ã§ç¢ºå®šï¼
  }
  if (e.key === 'Escape') {
    finish(false);           // Esc ã¯å¾“æ¥ã©ãŠã‚Š
  }
});

  input.addEventListener('blur', () => finish(true));

  nameSpan.replaceWith(input);
  input.focus();
  input.select();
});

//åŒä¸€ã‚¿ã‚°ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
addLayerSTBtn.addEventListener("click", () => {
  console.log("add-layer-same-tags pushed!");
  const active = manager.getActiveLayer();
  if (!active) return;

  // namePartsï¼ˆ['é«ª','ç·šç”»'] or ['é«ª','ç·šç”»','2']ï¼‰ãªã©ã‚’ã‚³ãƒ”ãƒ¼
  const parts = [...active.nameParts];
  let num = 1;

  // æœ«å°¾ãŒæ•°å­—ãªã‚‰å–ã‚Šå‡ºã—ã¦é…åˆ—ã‹ã‚‰å‰Šé™¤
  const last = parts[parts.length - 1];
  if (/^\d+$/.test(last)) {
    num = parseInt(last, 10);
    parts.pop();
  }

  // æ–°ã—ã„åå‰ã‚’ä½œã£ã¦è¿½åŠ ï¼
  const newName = parts.join('_') + '_' + (num + 1);
  manager.addLayer(newName);
});
brushWidthSlider.addEventListener('input', () => {
  const size = +brushWidthSlider.value;

  // â¶ ãƒ„ãƒ¼ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ 
  toolMgr.ctx.brush.size = size;
  brushSizeDisplay.textContent = size;

  // â· ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«ãŒãƒ–ãƒ©ã‚·ã ã£ãŸã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å³åæ˜ 
  if (toolMgr.current === toolMgr.ctx.brush) {
    const layerCtx = manager.getActiveLayer().ctx;
    layerCtx.lineWidth = size;
    layerCtx.lineCap = 'round';     // ã¤ã„ã§ã«ä¿æŒã•ã‚Œã¦ãªã„ãªã‚‰ã“ã“ã§è¨­å®š
    layerCtx.lineJoin = 'round';    // ãŠå¥½ã¿ã§
    layerCtx.globalCompositeOperation = 'source-over'; // é€šå¸¸æç”»ã«æˆ»ã™
  }
});


eraserWidthSlider.addEventListener('input', () => {
  const size = +eraserWidthSlider.value;
  // â¶ ãƒ„ãƒ¼ãƒ«æœ¬ä½“ã®ã‚µã‚¤ã‚ºæ›´æ–°
  toolMgr.ctx.eraser.size = size;
  eraserSizeDisplay.textContent = size;

  // â· ã€Œä»Šé¸æŠä¸­ã€ã‹ã¤ã€Œæ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ä¸­ã€ãªã‚‰ã€ã™ãã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚‚åæ˜ 
  if (toolMgr.current === toolMgr.ctx.eraser) {
    const layerCtx = manager.getActiveLayer().ctx;
    layerCtx.lineWidth = size;
    layerCtx.globalCompositeOperation = 'destination-out';
  }
});


//æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ã¨æŠ•ã’ç¸„å¡—ã‚Šã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
const modeToggle = document.getElementById('mode-toggle');
const nagenawaFill = document.getElementById('nagenawafill-toggle');

modeToggle.addEventListener('click', () => {
  const currentTool = toolMgr.current.name;

  if (currentTool === "Brush") {
    toolMgr.select("eraser");
    modeToggle.textContent = "ãƒšãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ";
  } else {
    toolMgr.select("brush");
    modeToggle.textContent = "æ¶ˆã—ã‚´ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ";
  }
});
//åˆæœŸåŒ–
modeToggle.textContent = "æ¶ˆã—ã‚´ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ";

//æŠ•ã’ç¸„å¡—ã‚Šã®ãƒœã‚¿ãƒ³
let nage = false;
nagenawaFill.addEventListener('click', () => {
  nage = !nage;

  nagenawaFill.innerHTML = `æŠ•ã’ãªã‚å¡—ã‚Šï¼š<span class="onoff">${nage ? "ON" : "OFF"}</span>`;
  nagenawaFill.classList.toggle('active', nage);
});


  //ãƒœã‚¿ãƒ³
  // ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º Â±1px
brushDecreaseBtn.addEventListener('click', () => {
  let v = parseInt(brushWidthSlider.value, 10); //ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤(æ–‡å­—åˆ—)ã‚’10é€²æ•°ã«å¤‰æ›
  if (v > parseInt(brushWidthSlider.min, 10)) v--;
  brushWidthSlider.value = v;
  brushSizeDisplay.textContent = v;
  if (!isErasing) manager.getActiveLayer().ctx.lineWidth = v;
});
brushIncreaseBtn.addEventListener('click', () => {
  let v = parseInt(brushWidthSlider.value, 10);
  if (v < parseInt(brushWidthSlider.max, 10)) v++;
  brushWidthSlider.value = v;
  brushSizeDisplay.textContent = v;
  if (!isErasing) manager.getActiveLayer().ctx.lineWidth = v;
});

// æ¶ˆã—ã‚´ãƒ ã‚µã‚¤ã‚º Â±1px
eraserDecreaseBtn.addEventListener('click', () => {
  let v = parseInt(eraserWidthSlider.value, 10);
  if (v > parseInt(eraserWidthSlider.min, 10)) v--;
  eraserWidthSlider.value = v;
  eraserSizeDisplay.textContent = v;
  if (isErasing) manager.getActiveLayer().ctx.lineWidth = v;
});
eraserIncreaseBtn.addEventListener('click', () => {
  let v = parseInt(eraserWidthSlider.value, 10);
  if (v < parseInt(eraserWidthSlider.max, 10)) v++;
  eraserWidthSlider.value = v;
  eraserSizeDisplay.textContent = v;
  if (isErasing) manager.getActiveLayer().ctx.lineWidth = v;
});

//å–ã‚Šæ¶ˆã—ãƒ»ã‚„ã‚Šç›´ã—
undoButton.addEventListener("click", (e) => {
  // Ctrl + Z â†’ Undo
    appHistory.undo();
    e.preventDefault();  // ãƒ–ãƒ©ã‚¦ã‚¶ã®å…ƒã®å‹•ä½œï¼ˆæˆ»ã‚‹ï¼‰ã‚’ç„¡åŠ¹åŒ–
});
redoButton.addEventListener("click", (e) => {
  // Ctrl + Z â†’ Undo
    appHistory.redo();
    e.preventDefault();  // ãƒ–ãƒ©ã‚¦ã‚¶ã®å…ƒã®å‹•ä½œï¼ˆæˆ»ã‚‹ï¼‰ã‚’ç„¡åŠ¹åŒ–
});
  </script>

  <script>// ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
const colorInput = document.getElementById('color-picker');
const alphaInput = document.getElementById('alpha');
const alphaDisplay = document.getElementById('alpha-display');

//åˆæœŸè‰²è¨­å®šã€‚ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’16é€²æ•°ã‹ã‚‰10é€²æ•°ã«å¤‰æ¡ˆã€ä¸é€æ˜åº¦ã¨åˆæˆã—ã¦rgbaã«ã—ãŸå¾Œã€

function updateBrushColor() {
  const hex = colorInput.value;
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const a = alphaInput.value / 100;

  const rgba = `rgba(${r}, ${g}, ${b}, ${a})`;
  //ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç·šè‰²ã‚’å¤‰æ›´â€»ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãªã„ã¨ãƒã‚°ã‚‹ã®ã§æ³¨æ„(ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®Ÿè£…ã‚’æ¤œè¨)
  manager.getActiveLayer().ctx.strokeStyle = rgba;
  //console.log("color changed!");
}

// è‰²ãƒ»ä¸é€æ˜åº¦ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
colorInput.addEventListener('input', updateBrushColor);
alphaInput.addEventListener('input', () => {
  alphaDisplay.textContent = alphaInput.value;
  updateBrushColor();
});

//ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚wrapperã«ä¾å­˜ã€‚ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…æ™‚ã«ã„ã˜ã‚‹å¿…è¦ã‚ã‚Šã€‚
function resizeCanvases() {
  const wrapper = document.getElementById('canvas-wrapper');
  const width = wrapper.clientWidth;
  const height = wrapper.clientHeight;

  const canvases = wrapper.querySelectorAll('canvas');
  canvases.forEach(canvas => {
    canvas.width = width;   // æç”»è§£åƒåº¦ã®è¨­å®šï¼ˆã“ã‚ŒãŒãªã„ã¨ãƒœã‚±ã‚‹ï¼‰
    canvas.height = height;
  });
  cursorCanvas.width = wrapper.clientWidth;
  cursorCanvas.height = wrapper.clientHeight;

}
//ã“ã®ä¸­ã¯htmlã¨cssãŒèª­ã¿è¾¼ã¿çµ‚äº†ã—ã¦ã‹ã‚‰å‹•ã


</script>

<!--DOMå–å¾—ã«é–¢ã‚ã‚‹ã‚³ãƒ¼ãƒ‰-->
<script>
  appHistory = new History();
  window.addEventListener('load', () => {
  manager = new LayerManager(wrapper);
  baseLayer = manager.addLayer()
  manager.renderLayerPanel();
  resizeCanvases();
  manager.layers.forEach(layer => applyBrushStyle(layer.ctx));  //contextãŒresizeã§æ¶ˆãˆã‚‹ã®ã§å†é©ç”¨
  updateBrushColor(); // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®åˆæœŸåŒ–
  appHistory.reset();
  //manager.addLayer();
  //manager.addLayer();//for test
  DM = new DrawManager(wrapper, manager);
});

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ undo / redo ã‚’å®Ÿè¡Œ
window.addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === "z") {
    // Ctrl + Z ã¾ãŸã¯ Cmd + Z â†’ Undo
    appHistory.undo();
    e.preventDefault();  // ãƒ–ãƒ©ã‚¦ã‚¶ã®å…ƒã®å‹•ä½œï¼ˆæˆ»ã‚‹ï¼‰ã‚’ç„¡åŠ¹åŒ–
  }

  if (
    ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "y") || // Ctrl/Cmd + Y
    ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "z") // Ctrl/Cmd + Shift + Z
  ) {
    // Redo å‡¦ç†
    appHistory.redo();
    e.preventDefault();  // ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ä½œï¼ˆå†èª­ã¿è¾¼ã¿ãªã©ï¼‰ã‚’é˜²æ­¢
  }
});


</script>

<script>
// ========== æ¤œç´¢æ©Ÿèƒ½ï¼ˆlayer name AND/OR æ¤œç´¢å¯¾å¿œï¼‰ ==========

// â”€â”€ ã‚¯ã‚¨ãƒªãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆ"å…‰ and å½± or ãƒ©ãƒ•" â†’ [["å…‰","å½±"],["ãƒ©ãƒ•"]]ï¼‰â”€â”€
function parseSearchQuery(raw) {
  const s = raw.trim().toLowerCase();
  if (!s) return [];
  return s.split(/\s+or\s+/i)
          .map(orPart =>
            orPart.split(/\s+and\s+/i)
                  .map(tok => tok.trim())
                  .filter(tok => tok)
          );
}

// â”€â”€ å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼šæ¤œç´¢æ¬„ã®å…¥åŠ›ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«æ›´æ–° â”€â”€
document.getElementById("layer-search").addEventListener("input", e => {
  const q = e.target.value;
  manager.updateSearch(q);
  manager.renderSearchResults(q);
});

// â”€â”€ ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼šæ¤œç´¢æ¬„ãƒªã‚»ãƒƒãƒˆ â”€â”€
document.getElementById("layer-search-clear").addEventListener("click", () => {
  const input = document.getElementById("layer-search");
  input.value = "";
  manager.updateSearch("");
  manager.renderSearchResults("");
});
</script>
</body>
</html>